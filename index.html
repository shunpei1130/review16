<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>診断データ解析ツール（静的サイト）</title>

  <!-- UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables (Bootstrap 5) -->
  <link href="https://cdn.datatables.net/2.3.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/responsive/3.0.7/css/responsive.bootstrap5.min.css" rel="stylesheet">

  <link href="./style.css" rel="stylesheet" />
</head>

<body>
  <div class="container py-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
      <div>
        <h1 class="h3 mb-1">診断データ解析ツール（静的サイト）</h1>
        <div class="text-muted small">
          Excel（.xlsx）をブラウザ内で読み込み、集計・可視化・品質チェックを行います。データはページ外へ送信しません（解析はローカル処理）。
          <span class="d-inline-block ms-1">※ライブラリはCDNから読み込みます。</span>
        </div>
      </div>
      <div class="text-end">
        <a class="small" href="./README.md" target="_blank" rel="noreferrer">使い方（README）</a>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-lg-6">
            <label class="form-label">Excelファイル</label>
            <input id="fileInput" type="file" class="form-control" accept=".xlsx,.xls" />
            <div class="form-text">
              例：このチャットで渡した「診断データ.xlsx」
            </div>
          </div>
          <div class="col-lg-6">
            <div class="d-flex flex-wrap gap-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="maskPII" checked>
                <label class="form-check-label" for="maskPII">PIIをマスク（name/emailなど）</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="showJsonCols">
                <label class="form-check-label" for="showJsonCols">JSON列を表示（*_json / raw_json など）</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="showUnnamedCols">
                <label class="form-check-label" for="showUnnamedCols">Unnamed列を表示</label>
              </div>
            </div>

            <div class="mt-3">
              <div id="loadStatus" class="small text-muted">ファイル未読込</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-overview" data-bs-toggle="tab" data-bs-target="#pane-overview" type="button" role="tab">ダッシュボード</button>
      </li>

      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-diagnosis" data-bs-toggle="tab" data-bs-target="#pane-diagnosis" type="button" role="tab">診断分析</button>
      </li>



      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-referral" data-bs-toggle="tab" data-bs-target="#pane-referral" type="button" role="tab">紹介深掘り</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-sheet" data-bs-toggle="tab" data-bs-target="#pane-sheet" type="button" role="tab">シート探索</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-profile" data-bs-toggle="tab" data-bs-target="#pane-profile" type="button" role="tab">プロファイル</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-charts" data-bs-toggle="tab" data-bs-target="#pane-charts" type="button" role="tab">可視化</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-export" data-bs-toggle="tab" data-bs-target="#pane-export" type="button" role="tab">エクスポート</button>
      </li>
    </ul>

    <div class="tab-content border border-top-0 rounded-bottom p-3 bg-white" id="mainTabsContent">

      <!-- Overview -->
      <div class="tab-pane fade show active" id="pane-overview" role="tabpanel" aria-labelledby="tab-overview">
        <div id="overviewEmpty" class="text-muted">
          まずExcelファイルを選択してください。
        </div>

        <div id="overviewContent" class="d-none">
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">シート数</div>
                  <div class="h4 mb-0" id="kpiSheetCount">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">総行数（全シート合計）</div>
                  <div class="h4 mb-0" id="kpiTotalRows">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">diagnosis 行数</div>
                  <div class="h4 mb-0" id="kpiDiagnosisRows">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">referral_events 行数</div>
                  <div class="h4 mb-0" id="kpiReferralEventsRows">-</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="fw-semibold">シート一覧</div>
                    <div class="small text-muted">クリックで探索へ</div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0" id="sheetSummaryTable">
                      <thead>
                        <tr>
                          <th>sheet</th>
                          <th class="text-end">rows</th>
                          <th class="text-end">cols</th>
                          <th class="text-end">missing%</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">自動インサイト（代表シートがある場合）</div>
                  <div id="insights" class="small"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-0">
            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">診断：type 上位（diagnosis）</div>
                  <div id="plotTypeTop" class="plotBox"></div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">紹介：イベント推移（events_daily / referral_events）</div>
                  <div id="plotEventsDaily" class="plotBox"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-0">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="fw-semibold mb-2">紹介：Sankey（sankey_visits / sankey_completes がある場合）</div>
                  <div class="row g-3">
                    <div class="col-lg-6">
                      <div class="small text-muted mb-1">Visits</div>
                      <div id="plotSankeyVisits" class="plotBox"></div>
                    </div>
                    <div class="col-lg-6">
                      <div class="small text-muted mb-1">Completes</div>
                      <div id="plotSankeyCompletes" class="plotBox"></div>
                    </div>
                  </div>
                  <div class="small text-muted mt-2">
                    ※Sankeyは source / target / value の3列を想定
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Diagnosis -->
      <div class="tab-pane fade" id="pane-diagnosis" role="tabpanel" aria-labelledby="tab-diagnosis">
        <div id="diagEmpty" class="text-muted">
          まずExcelファイルを選択してください。
        </div>

        <div id="diagNoSheet" class="d-none text-muted">
          diagnosis シートが見つかりません。
        </div>

        <div id="diagContent" class="d-none">

          <div class="row g-3 align-items-end mb-3">
            <div class="col-lg-3">
              <label class="form-label">期間（開始）</label>
              <input id="diagDateStart" type="date" class="form-control" />
            </div>
            <div class="col-lg-3">
              <label class="form-label">期間（終了）</label>
              <input id="diagDateEnd" type="date" class="form-control" />
            </div>
            <div class="col-lg-2">
              <label class="form-label">gender</label>
              <select id="diagGender" class="form-select">
                <option value="all">all</option>
                <option value="female">female</option>
                <option value="male">male</option>
                <option value="unknown">unknown</option>
              </select>
            </div>
            <div class="col-lg-4">
              <label class="form-label">type</label>
              <select id="diagType" class="form-select"></select>
            </div>

            <div class="col-lg-2">
              <label class="form-label">年齢 min</label>
              <input id="diagAgeMin" type="number" class="form-control" placeholder="例: 13" />
            </div>
            <div class="col-lg-2">
              <label class="form-label">年齢 max</label>
              <input id="diagAgeMax" type="number" class="form-control" placeholder="例: 26" />
            </div>
            <div class="col-lg-4 d-flex flex-wrap gap-3 align-items-center">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="diagIncludeMissingAge" checked>
                <label class="form-check-label" for="diagIncludeMissingAge">年齢欠損を含める</label>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <button id="btnDiagApply" class="btn btn-primary btn-sm">適用</button>
                <button id="btnDiagReset" class="btn btn-outline-secondary btn-sm">リセット</button>
              </div>
              <div class="small text-muted" id="diagN">N=-</div>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">件数</div>
                  <div class="h4 mb-0" id="diagKpiRows">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">Interested率</div>
                  <div class="h4 mb-0" id="diagKpiInterestedRate">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">ユニークemail</div>
                  <div class="h4 mb-0" id="diagKpiUniqueEmail">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">年齢中央値</div>
                  <div class="h4 mb-0" id="diagKpiAgeMedian">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">female比率</div>
                  <div class="h4 mb-0" id="diagKpiFemaleRate">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">raw_json解析</div>
                  <div class="h4 mb-0" id="diagKpiJsonParseRate">-</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">type 件数（上位）</div>
                  <div id="plotDiagTypeCount" class="plotBox"></div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">type別 Interested率（上位）</div>
                  <div id="plotDiagInterestedByType" class="plotBox"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-0">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                    <div class="fw-semibold">type サマリ</div>
                    <div class="small text-muted">n, Interested率, 軸平均など（上位）</div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle" id="diagTypeTable">
                      <thead>
                        <tr>
                          <th>type</th>
                          <th class="text-end">n</th>
                          <th class="text-end">interested</th>
                          <th class="text-end">rate</th>
                          <th class="text-end">axisA</th>
                          <th class="text-end">axisB</th>
                          <th class="text-end">axisC</th>
                          <th class="text-end">axisD</th>
                          <th class="text-end">age_mean</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                  <div class="small text-muted mt-2">※表示は上位50タイプ。フィルタ適用後に再計算されます。</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-0">
            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <div class="d-flex flex-wrap gap-2 align-items-end justify-content-between mb-2">
                    <div class="fw-semibold">軸スコア分布（Box）</div>
                    <div class="d-flex flex-wrap gap-2">
                      <select id="diagAxisSelect" class="form-select form-select-sm">
                        <option value="axisA">axisA</option>
                        <option value="axisB">axisB</option>
                        <option value="axisC">axisC</option>
                        <option value="axisD">axisD</option>
                      </select>
                      <select id="diagAxisGroupBy" class="form-select form-select-sm">
                        <option value="type">group: type</option>
                        <option value="gender">group: gender</option>
                        <option value="ageBin">group: age bin</option>
                      </select>
                      <input id="diagAxisTopN" type="number" class="form-control form-control-sm" style="max-width: 110px" value="10" min="3" max="30" />
                    </div>
                  </div>
                  <div id="plotDiagAxisBox" class="plotBox"></div>
                  <div class="small text-muted mt-2">※group=type の場合、上位Nタイプのみ表示。</div>
                </div>
              </div>
            </div>

            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">相関（axis + age + interested）</div>
                  <div id="plotDiagCorr" class="plotBox"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-0">
            <div class="col-lg-4">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">Interested率：年齢帯</div>
                  <div id="plotDiagInterestedByAge" class="plotBox"></div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">Interested率：gender</div>
                  <div id="plotDiagInterestedByGender" class="plotBox"></div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">Dominant axis（最大軸）</div>
                  <div id="plotDiagDominantAxis" class="plotBox"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-0">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex flex-wrap gap-2 align-items-end justify-content-between mb-2">
                    <div>
                      <div class="fw-semibold">質問（answers）分析</div>
                      <div class="small text-muted">raw_json 内の answers（A1〜D10）を利用</div>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                      <select id="diagQKey" class="form-select form-select-sm"></select>
                      <button id="btnDiagDrawQ" class="btn btn-outline-primary btn-sm">描画</button>
                    </div>
                  </div>

                  <div class="row g-3">
                    <div class="col-lg-6">
                      <div class="small text-muted mb-1">分布（全体）</div>
                      <div id="plotDiagQHist" class="plotBox"></div>
                    </div>
                    <div class="col-lg-6">
                      <div class="small text-muted mb-1">平均：type別（上位）</div>
                      <div id="plotDiagQMeanByType" class="plotBox"></div>
                    </div>
                  </div>

                  <div class="row g-3 mt-0">
                    <div class="col-lg-12">
                      <div class="small text-muted">
                        Interested=1 の平均: <span class="fw-semibold" id="diagQMeanInterested">-</span>
                        <span class="mx-2">/</span>
                        Interested=0 の平均: <span class="fw-semibold" id="diagQMeanNotInterested">-</span>
                        <span class="mx-2">/</span>
                        差分: <span class="fw-semibold" id="diagQMeanDiff">-</span>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-0">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="fw-semibold mb-2">データ品質（diagnosis）</div>
                  <div class="row g-3">
                    <div class="col-md-3">
                      <div class="border rounded p-2">
                        <div class="small text-muted">email 重複数</div>
                        <div class="h5 mb-0" id="diagQualityDupEmail">-</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="border rounded p-2">
                        <div class="small text-muted">年齢パース不可</div>
                        <div class="h5 mb-0" id="diagQualityBadAge">-</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="border rounded p-2">
                        <div class="small text-muted">軸の範囲外</div>
                        <div class="h5 mb-0" id="diagQualityAxisOut">-</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="border rounded p-2">
                        <div class="small text-muted">createdAt 欠損</div>
                        <div class="h5 mb-0" id="diagQualityNoDate">-</div>
                      </div>
                    </div>
                  </div>
                  <div class="small text-muted mt-2">※フィルタ適用後の件数で表示。</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

<!-- Referral Deep Dive -->
      <div class="tab-pane fade" id="pane-referral" role="tabpanel" aria-labelledby="tab-referral">
        <div id="referralEmpty" class="text-muted">
          まずExcelファイルを選択してください。
        </div>

        <div id="referralContent" class="d-none">
          <div class="row g-3 mb-3">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="fw-semibold mb-2">期間フィルタ（referral_events.timestamp）</div>
                  <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                      <label class="form-label">開始日</label>
                      <input type="date" id="refStartDate" class="form-control" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">終了日</label>
                      <input type="date" id="refEndDate" class="form-control" />
                    </div>
                    <div class="col-md-4 d-flex flex-wrap gap-2">
                      <button id="btnRefApply" class="btn btn-primary btn-sm">適用</button>
                      <button id="btnRefReset" class="btn btn-outline-secondary btn-sm">全期間</button>
                    </div>
                  </div>
                  <div class="small text-muted mt-2" id="refFilterHint">-</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mb-3" id="refKpiRow">
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">share</div>
                  <div class="h4 mb-0" id="kpiRefShare">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">referral_visit</div>
                  <div class="h4 mb-0" id="kpiRefVisit">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">referral_complete</div>
                  <div class="h4 mb-0" id="kpiRefComplete">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">share→visit</div>
                  <div class="h4 mb-0" id="kpiRefRateSV">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">visit→complete</div>
                  <div class="h4 mb-0" id="kpiRefRateVC">-</div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card h-100">
                <div class="card-body">
                  <div class="small text-muted">share→complete</div>
                  <div class="h4 mb-0" id="kpiRefRateSC">-</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-lg-8">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">イベント推移（share / visit / complete）</div>
                  <div id="plotRefTimeSeries" class="plotBox"></div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">share プラットフォーム内訳</div>
                  <div id="plotSharePlatform" class="plotBox"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">referrer type 別の紹介効率</div>
                  <div id="plotTypePerformance" class="plotBox"></div>
                  <div class="small text-muted mt-2">※shareイベントのpayload（userType）から referrer type を推定します。</div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-body">
                  <div class="fw-semibold mb-2">referrer別：visitors vs completes</div>
                  <div id="plotRefScatter" class="plotBox"></div>
                </div>
              </div>
            </div>
          </div>

                    <div class="row g-3 mb-3">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="fw-semibold mb-2">紹介経由ユーザーの診断特徴（email join）</div>
                  <div class="row g-3">
                    <div class="col-lg-4">
                      <div class="small text-muted">紹介完了ユーザー（ユニーク email）</div>
                      <div class="h4 mb-3" id="kpiReferredUniqueEmail">-</div>

                      <div class="small text-muted">diagnosis と一致（ユニーク email）</div>
                      <div class="h4 mb-3" id="kpiReferredMatched">-</div>

                      <div class="small text-muted">interested=1（紹介完了 / 全体）</div>
                      <div class="h4 mb-0" id="kpiReferredInterested">-</div>

                      <div class="small text-muted mt-2">
                        ※ referral_complete の payload（userEmail）と diagnosis.email を突合します。<br/>
                        個人を特定できる情報は表示しません（件数のみ）。
                      </div>
                    </div>
                    <div class="col-lg-8">
                      <div id="plotReferredTypeCompare" class="plotBox"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div><div class="row g-3 mb-3">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                    <div class="fw-semibold">リファラー一覧（Leaderboard）</div>
                    <div class="small text-muted">行クリックで詳細へ</div>
                  </div>
                  <div class="table-responsive">
                    <table id="referrerTable" class="table table-striped table-bordered w-100">
                      <thead></thead>
                      <tbody></tbody>
                    </table>
                  </div>
                  <div class="small text-muted mt-2">
                    ※ 原則 referral_events から集計します（referrer_summary がある場合は referrerId の候補に利用します）。
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                    <div class="fw-semibold">リファラー詳細</div>
                    <div class="d-flex flex-wrap gap-2">
                      <select id="referrerSelect" class="form-select form-select-sm" style="min-width: 260px;"></select>
                      <button id="btnRefDetailRefresh" class="btn btn-outline-secondary btn-sm">更新</button>
                    </div>
                  </div>

                  <div id="referrerDetailKpis" class="row g-3"></div>

                  <hr/>

                  <div class="row g-3">
                    <div class="col-lg-6">
                      <div class="fw-semibold mb-2">招待ユーザーの推移</div>
                      <div id="plotReferrerTimeline" class="plotBox"></div>
                    </div>
                    <div class="col-lg-6">
                      <div class="fw-semibold mb-2">Time to complete（hours）</div>
                      <div id="plotHoursToComplete" class="plotBox"></div>
                    </div>
                  </div>

                  <hr/>

                  <div class="fw-semibold mb-2">Edge一覧（referrer → user）</div>
                  <div class="table-responsive">
                    <table id="refEdgesTable" class="table table-sm table-striped table-bordered w-100">
                      <thead></thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="fw-semibold mb-2">紹介ネットワーク（Sankey）</div>
                  <div class="row g-3 align-items-end mb-2">
                    <div class="col-md-4">
                      <label class="form-label">種類</label>
                      <select id="refSankeyKind" class="form-select form-select-sm">
                        <option value="visits">Visits</option>
                        <option value="completes">Completes</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">データ</label>
                      <select id="refSankeyVariant" class="form-select form-select-sm">
                        <option value="prefer_acyclic">acyclicを優先</option>
                        <option value="raw">rawを優先</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">min value（link）</label>
                      <input id="refSankeyMinValue" type="number" class="form-control form-control-sm" value="1" min="0" step="1" />
                    </div>
                  </div>

                  <div id="plotReferralSankey" class="plotBox"></div>
                  <div class="small text-muted mt-2" id="refNetworkStats">-</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Sheet explorer -->
      <div class="tab-pane fade" id="pane-sheet" role="tabpanel" aria-labelledby="tab-sheet">
        <div id="sheetEmpty" class="text-muted">
          まずExcelファイルを選択してください。
        </div>

        <div id="sheetContent" class="d-none">
          <div class="row g-3 align-items-end mb-3">
            <div class="col-lg-6">
              <label class="form-label">対象シート</label>
              <select id="sheetSelect" class="form-select"></select>
            </div>
            <div class="col-lg-6 d-flex flex-wrap gap-2 justify-content-lg-end">
              <button id="btnRefreshView" class="btn btn-outline-secondary btn-sm">再描画</button>
              <button id="btnGoProfile" class="btn btn-outline-primary btn-sm">プロファイルへ</button>
              <button id="btnGoCharts" class="btn btn-outline-primary btn-sm">可視化へ</button>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                    <div class="fw-semibold">テーブル</div>
                    <div class="small text-muted" id="sheetMeta">-</div>
                  </div>
                  <div class="table-responsive">
                    <table id="dataTable" class="table table-striped table-bordered w-100">
                      <thead></thead>
                      <tbody></tbody>
                    </table>
                  </div>
                  <div class="small text-muted mt-2">
                    ※検索・並び替え・ページング対応（DataTables）
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile -->
      <div class="tab-pane fade" id="pane-profile" role="tabpanel" aria-labelledby="tab-profile">
        <div id="profileEmpty" class="text-muted">
          まずExcelファイルを選択してください。
        </div>

        <div id="profileContent" class="d-none">
          <div class="row g-3 align-items-end mb-3">
            <div class="col-lg-6">
              <label class="form-label">対象シート</label>
              <select id="profileSheetSelect" class="form-select"></select>
            </div>
            <div class="col-lg-6 d-flex flex-wrap gap-2 justify-content-lg-end">
              <button id="btnProfileRecalc" class="btn btn-outline-secondary btn-sm">再計算</button>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <div class="fw-semibold mb-2">列プロファイル</div>
                  <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle" id="profileTable">
                      <thead>
                        <tr>
                          <th>column</th>
                          <th>type</th>
                          <th class="text-end">missing</th>
                          <th class="text-end">unique</th>
                          <th class="text-end">min</th>
                          <th class="text-end">p50</th>
                          <th class="text-end">max</th>
                          <th>top values (up to 5)</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                  <div class="small text-muted mt-2">
                    ※数値列は min/p50/max を表示。文字列列は top values を表示。
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Charts -->
      <div class="tab-pane fade" id="pane-charts" role="tabpanel" aria-labelledby="tab-charts">
        <div id="chartsEmpty" class="text-muted">
          まずExcelファイルを選択してください。
        </div>

        <div id="chartsContent" class="d-none">
          <div class="row g-3 align-items-end mb-3">
            <div class="col-lg-4">
              <label class="form-label">対象シート</label>
              <select id="chartsSheetSelect" class="form-select"></select>
            </div>
            <div class="col-lg-3">
              <label class="form-label">可視化タイプ</label>
              <select id="chartType" class="form-select">
                <option value="hist">ヒストグラム（数値）</option>
                <option value="barCount">棒（カテゴリ件数）</option>
                <option value="scatter">散布図（数値×数値）</option>
                <option value="lineTime">折れ線（日時×数値）</option>
                <option value="corr">相関ヒートマップ（数値列）</option>
                <option value="sankey">Sankey（source/target/value）</option>
              </select>
            </div>
            <div class="col-lg-3">
              <label class="form-label">X列</label>
              <select id="xCol" class="form-select"></select>
            </div>
            <div class="col-lg-2">
              <label class="form-label">Y列</label>
              <select id="yCol" class="form-select"></select>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 mb-3">
            <button id="btnDrawChart" class="btn btn-primary btn-sm">描画</button>
            <button id="btnAutoPick" class="btn btn-outline-secondary btn-sm">自動選択</button>
            <span class="small text-muted align-self-center" id="chartHint">-</span>
          </div>

          <div class="card">
            <div class="card-body">
              <div id="chartArea" class="plotBox"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Export -->
      <div class="tab-pane fade" id="pane-export" role="tabpanel" aria-labelledby="tab-export">
        <div id="exportEmpty" class="text-muted">
          まずExcelファイルを選択してください。
        </div>

        <div id="exportContent" class="d-none">
          <div class="row g-3 align-items-end mb-3">
            <div class="col-lg-6">
              <label class="form-label">対象シート</label>
              <select id="exportSheetSelect" class="form-select"></select>
            </div>
            <div class="col-lg-6 d-flex flex-wrap gap-2 justify-content-lg-end">
              <button id="btnExportCsv" class="btn btn-outline-primary btn-sm">CSVで保存</button>
              <button id="btnExportJson" class="btn btn-outline-primary btn-sm">JSONで保存</button>
            </div>
          </div>

          <div class="small text-muted">
            ※ブラウザ上でダウンロードします（サーバ不要）。PIIマスクON時は出力もマスクされます。
          </div>

          <hr/>

          <div class="small">
            <div class="fw-semibold mb-1">補足</div>
            <ul class="mb-0">
              <li>テーブルのフィルタ結果だけを出力したい場合：まず「シート探索」タブで検索し、必要ならCSVを別途加工してください。</li>
              <li>JSON列（*_json / raw_json 等）はデフォルト非表示です。必要なら上部のチェックをONにしてください。</li>
            </ul>
          </div>
        </div>
      </div>

    </div> <!-- tab content -->
  </div> <!-- container -->

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- DataTables -->
  <script src="https://cdn.datatables.net/2.3.6/js/dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/3.0.7/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/3.0.7/js/responsive.bootstrap5.min.js"></script>

  <!-- Plotly -->
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/plotly.min.js"></script>

  <script src="./app.js"></script>
</body>
</html>
